# ADR 002: 音频处理方案决策

## 状态

已批准

## 上下文

SonicVision 需要实时捕获和分析音频输入，以驱动可视化效果和歌曲识别功能。音频处理是应用的核心功能之一，需要选择合适的技术方案来实现。

## 决策驱动因素

1. **实时性**：需要实时处理音频数据，确保可视化效果的同步性
2. **准确性**：音频分析需要足够准确，以生成有意义的可视化效果
3. **性能**：音频处理不应过度消耗系统资源，确保在不同设备上都能流畅运行
4. **浏览器兼容性**：需要支持主流现代浏览器
5. **功能完整性**：需要支持音频捕获、频率分析和录制等功能

## 考虑的选项

### 选项 1：Web Audio API + MediaRecorder API

- **Web Audio API**：用于音频捕获和频率分析
- **MediaRecorder API**：用于录制音频片段
- **AnalyserNode**：用于实时分析音频频率数据
- **AudioContext**：用于音频处理的核心接口

### 选项 2：第三方音频库

- **Howler.js**：高级音频库
- **Tone.js**：音频合成和处理库
- **MediaRecorder API**：用于录制音频片段

### 选项 3：原生 MediaStream API

- **MediaStream API**：直接使用 MediaStream 进行音频处理
- **自定义音频分析**：自行实现音频频率分析算法

## 决策

选择 **选项 1：Web Audio API + MediaRecorder API** 作为项目的音频处理方案。

## 理由

1. **标准规范**：Web Audio API 和 MediaRecorder API 都是 Web 标准，由 W3C 制定，具有良好的浏览器支持
2. **功能完整**：Web Audio API 提供了完整的音频处理功能，包括 AudioContext、AnalyserNode 等核心接口
3. **实时性能**：Web Audio API 专为实时音频处理设计，性能优异，延迟低
4. **准确性**：AnalyserNode 提供了准确的频率分析能力，支持不同精度的 FFT 分析
5. **易于集成**：与其他 Web API 无缝集成，如 MediaStream API
6. **无需外部依赖**：使用浏览器内置 API，减少项目依赖
7. **文档丰富**：有大量的文档和示例可供参考

## 后果

1. **正面影响**：
   - 高性能、低延迟的音频处理
   - 准确的频率分析数据
   - 良好的浏览器兼容性
   - 减少项目依赖

2. **负面影响**：
   - 学习曲线较陡，需要熟悉 Web Audio API 的概念和用法
   - 不同浏览器的实现细节可能存在差异，需要做兼容性处理
   - 音频处理参数需要根据设备性能进行调整

## 关键实现细节

1. **音频捕获**：使用 `navigator.mediaDevices.getUserMedia()` 获取麦克风输入
2. **频率分析**：使用 `AnalyserNode` 实时分析音频频率数据
3. **参数调整**：根据设备性能调整 `fftSize` 和 `smoothingTimeConstant` 参数
4. **音频录制**：使用 `MediaRecorder API` 录制音频片段用于歌曲识别
5. **错误处理**：实现全面的错误处理，包括权限错误、设备错误等
6. **资源管理**：正确释放音频资源，避免内存泄漏

## 替代方案考虑

- **Howler.js**：提供了更高级的音频处理功能，但对于本项目来说功能过于丰富，增加了不必要的依赖
- **Tone.js**：专注于音频合成和处理，对于本项目的实时分析需求来说不是最佳选择
- **自定义音频分析**：自行实现音频分析算法会增加开发难度和维护成本，且性能不如浏览器内置的 AnalyserNode

## 相关决策

- ADR 001：技术栈选择
- ADR 003：歌曲识别方案决策
- ADR 004：可视化技术决策