# ADR 004: 可视化技术决策

## 状态

已批准

## 上下文

SonicVision 需要根据音频数据生成动态、美观的可视化效果，包括 2D 和 3D 效果。可视化是应用的核心功能之一，需要选择合适的技术方案来实现。

## 决策驱动因素

1. **视觉效果**：需要生成美观、动态的可视化效果
2. **性能**：可视化渲染不应过度消耗系统资源，确保在不同设备上都能流畅运行
3. **灵活性**：支持多种可视化模式和参数调整
4. **易于实现**：技术方案易于实现和维护
5. **浏览器兼容性**：支持主流现代浏览器
6. **可扩展性**：便于添加新的可视化模式

## 考虑的选项

### 选项 1：Canvas 2D + Three.js

- **Canvas 2D API**：用于实现 2D 可视化效果
- **Three.js**：用于实现 3D WebGL 可视化效果
- **@react-three/fiber**：React 与 Three.js 的桥接库
- **@react-three/postprocessing**：Three.js 后期处理效果
- **策略模式**：为不同可视化模式实现独立的渲染策略

### 选项 2：SVG + Three.js

- **SVG**：用于实现 2D 可视化效果
- **Three.js**：用于实现 3D WebGL 可视化效果
- **@react-three/fiber**：React 与 Three.js 的桥接库

### 选项 3：纯 Three.js

- **Three.js**：同时用于实现 2D 和 3D 可视化效果
- **@react-three/fiber**：React 与 Three.js 的桥接库

### 选项 4：WebGL 原生

- **原生 WebGL**：直接使用 WebGL API 实现可视化效果
- **最大灵活性**：完全控制渲染过程
- **高性能**：避免库的开销

## 决策

选择 **选项 1：Canvas 2D + Three.js** 作为项目的可视化技术方案。

## 理由

1. **最佳组合**：Canvas 2D 适合实现简单的 2D 效果，Three.js 适合实现复杂的 3D 效果
2. **性能优化**：根据效果复杂度选择合适的渲染技术，平衡性能和视觉效果
3. **开发效率**：Three.js 简化了 WebGL 的使用，提高开发效率
4. **生态系统**：Three.js 拥有丰富的生态系统，包括各种插件和扩展
5. **可维护性**：使用策略模式，为不同可视化模式实现独立的渲染逻辑
6. **浏览器兼容性**：Canvas 2D 和 Three.js 都有良好的浏览器支持
7. **易于扩展**：便于添加新的可视化模式和效果

## 后果

1. **正面影响**：
   - 丰富多样的可视化效果
   - 良好的性能表现
   - 易于实现和维护
   - 便于添加新的可视化模式

2. **负面影响**：
   - 学习曲线较陡，需要熟悉 Canvas 2D 和 Three.js
   - 不同设备的性能差异需要考虑，需要做适应性调整
   - 3D 效果在低性能设备上可能需要降级处理

## 关键实现细节

1. **2D 可视化**：使用 Canvas 2D API 实现 BARS、PLASMA、PARTICLES 等 2D 模式
2. **3D 可视化**：使用 Three.js 实现 SILK、LIQUID、TERRAIN 等 3D 模式
3. **策略模式**：实现 VisualizerStrategy 接口，为每种模式提供独立的渲染逻辑
4. **参数调整**：支持调整灵敏度、速度、颜色主题等参数
5. **响应式设计**：确保可视化效果在不同屏幕尺寸上都能正常显示
6. **性能优化**：根据设备性能调整渲染参数，确保流畅运行

## 替代方案考虑

- **SVG**：SVG 适合实现矢量图形，但对于实时渲染的可视化效果，性能不如 Canvas 2D
- **纯 Three.js**：Three.js 也可以实现 2D 效果，但对于简单的 2D 效果，Canvas 2D 更轻量、更高效
- **WebGL 原生**：虽然灵活性最高，但开发复杂度高，维护成本大，不适合快速开发

## 相关决策

- ADR 001：技术栈选择
- ADR 002：音频处理方案决策
- ADR 003：歌曲识别方案决策