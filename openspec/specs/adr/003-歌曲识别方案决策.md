# ADR 003: 歌曲识别方案决策

## 状态

已批准

## 上下文

SonicVision 需要能够识别正在播放的歌曲，并显示歌曲信息和歌词片段。歌曲识别是应用的核心功能之一，需要选择合适的技术方案来实现。

## 决策驱动因素

1. **准确性**：需要准确识别不同类型的歌曲
2. **响应时间**：识别过程不应过长，影响用户体验
3. **易用性**：API 易于集成和使用
4. **成本效益**：考虑 API 使用成本
5. **功能完整性**：需要返回歌曲标题、艺术家、歌词等信息
6. **稳定性**：API 服务需要稳定可靠

## 考虑的选项

### 选项 1：Google Gemini API

- **Google Gemini API**：使用 Google 的生成式 AI 服务进行音频识别
- **支持音频输入**：直接接受音频数据作为输入
- **多语言支持**：支持识别不同语言的歌曲
- **详细结果**：返回歌曲标题、艺术家、歌词片段等信息

### 选项 2：Shazam API

- **Shazam API**：使用 Shazam 的专业歌曲识别服务
- **高准确性**：专门为歌曲识别优化，准确性高
- **快速响应**：识别速度快，响应时间短
- **详细结果**：返回丰富的歌曲信息

### 选项 3：ACRCloud API

- **ACRCloud API**：使用 ACRCloud 的音频识别服务
- **多类型识别**：支持识别音乐、电视、广播等多种内容
- **详细结果**：返回详细的歌曲信息和元数据
- **免费额度**：提供一定的免费使用额度

### 选项 4：本地音频指纹识别

- **本地音频指纹**：使用开源库在本地生成音频指纹
- **离线识别**：不需要网络连接
- **无使用成本**：不产生 API 调用费用
- **有限数据库**：识别范围取决于本地数据库大小

## 决策

选择 **选项 1：Google Gemini API** 作为项目的歌曲识别方案。

## 理由

1. **多模态能力**：Gemini API 支持多模态输入，不仅可以识别音频，还可以处理其他类型的输入
2. **强大的 AI 能力**：基于 Google 先进的生成式 AI 技术，识别准确性高
3. **易于集成**：提供官方的 JavaScript SDK（@google/genai），集成简单
4. **丰富的返回信息**：可以返回歌曲标题、艺术家、歌词片段、情绪等详细信息
5. **多语言支持**：支持识别不同语言的歌曲，符合项目的多语言需求
6. **持续改进**：Google 不断更新和改进 Gemini 模型，性能会持续提升
7. **生态系统**：与 Google 的其他服务和工具集成良好

## 后果

1. **正面影响**：
   - 高准确性的歌曲识别
   - 丰富的返回信息
   - 易于集成和使用
   - 多语言支持

2. **负面影响**：
   - API 使用成本：可能产生 API 调用费用
   - 网络依赖：需要网络连接才能使用
   - 响应时间：可能比专业歌曲识别服务稍慢
   - API 限制：可能存在调用频率和配额限制

## 关键实现细节

1. **音频录制**：使用 MediaRecorder API 录制 8-12 秒的音频片段
2. **格式转换**：将音频 Blob 转换为 base64 格式
3. **API 调用**：使用 @google/genai SDK 调用 Gemini API
4. **提示词设计**：精心设计提示词，确保 API 返回结构化的歌曲信息
5. **错误处理**：实现全面的错误处理，包括网络错误、API 限制等
6. **缓存机制**：缓存识别结果，避免短时间内重复识别同一首歌
7. **调用频率控制**：实现智能调度，避免频繁调用 API

## 替代方案考虑

- **Shazam API**：专业的歌曲识别服务，准确性高，但集成相对复杂，且可能有较高的使用成本
- **ACRCloud API**：功能丰富，有免费额度，但知名度和生态系统不如 Google Gemini
- **本地音频指纹**：无网络依赖和使用成本，但识别范围有限，准确性可能不如云端服务

## 相关决策

- ADR 001：技术栈选择
- ADR 002：音频处理方案决策
- ADR 004：可视化技术决策